<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>심플 웹페이지</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .text-gradient {
            background-image: linear-gradient(to right, #6b46c1, #a06e93);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #6b46c1;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <!-- 헤더 -->
    <header class="bg-white shadow-md py-4">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-gray-800">
                <span class="text-gradient">로고</span>
            </a>
            <nav class="hidden md:block">
                <ul class="flex space-x-6">
                    <li><a href="#" class="text-gray-600 hover:text-purple-600 transition-colors duration-300">홈</a></li>
                    <li><a href="#" class="text-gray-600 hover:text-purple-600 transition-colors duration-300">서비스</a></li>
                    <li><a href="#" class="text-gray-600 hover:text-purple-600 transition-colors duration-300">소개</a></li>
                    <li><a href="#" class="text-gray-600 hover:text-purple-600 transition-colors duration-300">연락처</a></li>
                </ul>
            </nav>
            <div id="auth-ui" class="flex items-center space-x-4">
                <!-- 로그인/로그아웃 UI가 여기에 동적으로 삽입됩니다. -->
            </div>
            <button id="mobile-menu-button" class="md:hidden text-gray-800 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                </svg>
            </button>
        </div>
        <!-- 모바일 메뉴 -->
        <div id="mobile-menu" class="hidden md:hidden bg-white shadow-lg py-2 mt-2">
            <ul class="flex flex-col items-center space-y-4">
                <li><a href="#" class="text-gray-600 hover:text-purple-600 transition-colors duration-300">홈</a></li>
                <li><a href="#" class="text-gray-600 hover:text-purple-600 transition-colors duration-300">서비스</a></li>
                <li><a href="#" class="text-gray-600 hover:text-purple-600 transition-colors duration-300">소개</a></li>
                <li><a href="#" class="text-gray-600 hover:text-purple-600 transition-colors duration-300">연락처</a></li>
            </ul>
        </div>
    </header>

    <!-- 메인 섹션 - 로그인 전 사용자에게 보입니다. -->
    <main id="main-section" class="flex-grow container mx-auto px-6 py-12 flex items-center justify-center">
        <div class="text-center">
            <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 leading-tight">
                <span class="text-gradient">새로운 경험을 시작하세요</span>
            </h1>
            <p class="mt-4 text-lg md:text-xl text-gray-600 max-w-2xl mx-auto">
                이것은 당신의 프로젝트를 위한 완벽한 출발점이 될 것입니다. 현대적이고 깨끗한 디자인으로 당신의 비전을 실현하세요.
            </p>
            <div class="mt-8 flex justify-center space-x-4">
                <button id="start-btn" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-purple-700 transition-transform transform hover:scale-105 duration-300">시작하기</button>
                <button class="bg-white text-purple-600 font-bold py-3 px-6 rounded-full border border-purple-600 hover:bg-purple-50 transition-transform transform hover:scale-105 duration-300">더 알아보기</button>
            </div>
        </div>
    </main>

    <!-- 대시보드 섹션 - 로그인 후 사용자에게 보입니다. -->
    <div id="user-dashboard" class="hidden flex-grow container mx-auto px-6 py-12">
        <div id="dashboard-content" class="bg-white rounded-lg shadow-lg p-8 md:p-12 mb-8">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center space-y-4 md:space-y-0 mb-6">
                <div class="flex items-center space-x-4">
                    <img id="user-photo" class="w-16 h-16 rounded-full border-2 border-purple-500" src="https://placehold.co/64x64/E5E7EB/1F2937?text=U" alt="사용자 프로필 사진">
                    <div>
                        <h2 id="welcome-message" class="text-3xl md:text-4xl font-bold text-gray-900">
                            안녕하세요, 환영합니다!
                        </h2>
                        <span id="user-id-display" class="block text-sm text-gray-500 mt-1"></span>
                    </div>
                </div>
            </div>
            <p class="text-gray-600 mb-6">
                이곳은 당신을 위해 특별히 준비된 개인 대시보드입니다. 아래에서 최신 정보와 유용한 리소스를 확인하세요.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 정보 카드 1 -->
                <div class="bg-gray-50 rounded-lg p-6 shadow hover:shadow-lg transition-shadow duration-300">
                    <h3 class="text-xl font-semibold text-purple-600 mb-2">오늘의 미션</h3>
                    <p class="text-gray-600">오늘의 할 일 목록을 확인하고 목표를 달성하세요.</p>
                </div>
                <!-- 정보 카드 2 - 내 기록 -->
                <div class="bg-gray-50 rounded-lg p-6 shadow hover:shadow-lg transition-shadow duration-300 cursor-pointer" id="my-history-btn">
                    <h3 class="text-xl font-semibold text-purple-600 mb-2">내 기록</h3>
                    <p class="text-gray-600">내가 풀이했던 문제들을 다시 확인하세요.</p>
                </div>
                <!-- 새롭게 추가된 기능 버튼 -->
                <div class="bg-purple-50 rounded-lg p-6 shadow hover:shadow-lg transition-shadow duration-300 cursor-pointer" id="ocr-btn">
                    <h3 class="text-xl font-semibold text-purple-700 mb-2">문제 풀이 서포터</h3>
                    <p class="text-gray-700">책을 찍고 문제 풀이 도움을 받으세요.</p>
                </div>
                <!-- 커뮤니티 채팅 버튼 -->
                <div class="bg-blue-50 rounded-lg p-6 shadow hover:shadow-lg transition-shadow duration-300 cursor-pointer" id="community-btn">
                    <h3 class="text-xl font-semibold text-blue-700 mb-2">커뮤니티</h3>
                    <p class="text-gray-700">다른 사람들과 자유롭게 대화하세요.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- OCR/문제 풀이 서포터 섹션 -->
    <div id="ocr-section" class="hidden flex-grow container mx-auto px-6 py-12">
        <div class="bg-white rounded-lg shadow-lg p-8 md:p-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">문제 풀이 서포터</h2>
            <p class="text-gray-600 mb-4">문제 풀이 도움을 받으려면 책이나 문제의 사진을 업로드하세요.</p>
            <input type="file" id="image-upload" accept="image/*" class="mb-4">
            
            <div id="image-container" class="mb-4 flex justify-center items-center p-4 border-2 border-dashed border-gray-300 rounded-lg">
                <span class="text-gray-400">이미지 미리보기</span>
            </div>
            
            <button id="process-image-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-purple-700 transition-colors duration-300 mb-4 w-full md:w-auto">
                문제 분석하기
            </button>

            <div id="status-area" class="text-center text-gray-500 mb-4 hidden">
                <div class="loading-spinner mx-auto mb-2"></div>
                <p id="status-message">이미지를 분석하는 중...</p>
            </div>
            
            <div id="results-area" class="hidden">
                <h3 class="text-xl font-semibold text-gray-700 mt-4 mb-2">추출된 텍스트:</h3>
                <pre id="ocr-text" class="bg-gray-100 p-4 rounded-lg whitespace-pre-wrap text-gray-800 text-sm"></pre>
                
                <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-2">문제 풀이:</h3>
                <div id="solution-text" class="bg-purple-50 p-4 rounded-lg text-gray-800"></div>
            </div>

            <button id="back-to-dashboard-btn" class="mt-8 text-gray-600 hover:text-purple-600 transition-colors duration-300">
                &larr; 대시보드로 돌아가기
            </button>
        </div>
    </div>

    <!-- 내 기록 섹션 -->
    <div id="history-section" class="hidden flex-grow container mx-auto px-6 py-12">
        <div class="bg-white rounded-lg shadow-lg p-8 md:p-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">내 기록</h2>
            <div id="history-list" class="space-y-6">
                <p class="text-gray-500">아직 저장된 풀이 기록이 없습니다.</p>
            </div>
            <button id="back-from-history-btn" class="mt-8 text-gray-600 hover:text-purple-600 transition-colors duration-300">
                &larr; 대시보드로 돌아가기
            </button>
        </div>
    </div>

    <!-- 커뮤니티 섹션 -->
    <div id="community-section" class="hidden flex-grow container mx-auto px-6 py-12">
        <div class="bg-white rounded-lg shadow-lg p-8 md:p-12 h-full flex flex-col">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">커뮤니티 채팅</h2>
            <div id="chat-messages" class="flex-grow overflow-y-auto mb-4 p-4 border rounded-lg bg-gray-50 space-y-4">
                <p class="text-gray-500 text-center">채팅 메시지를 불러오는 중...</p>
            </div>
            <div class="flex">
                <input type="text" id="chat-input" placeholder="메시지를 입력하세요..." class="flex-grow rounded-l-lg border-t border-b border-l border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="send-chat-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-r-lg hover:bg-blue-700 transition-colors duration-300">전송</button>
            </div>
            <button id="back-from-community-btn" class="mt-8 text-gray-600 hover:text-blue-600 transition-colors duration-300">
                &larr; 대시보드로 돌아가기
            </button>
        </div>
    </div>

    <!-- 푸터 -->
    <footer class="bg-gray-800 text-white py-6">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; 2023 심플 웹페이지. 모든 권리 보유.</p>
        </div>
    </footer>

    <!-- Tesseract.js 및 Firebase SDK 로드 -->
    <script src='https://unpkg.com/tesseract.js@2.1.4/dist/tesseract.min.js'></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 전역 변수 설정 (캔버스 환경에서 제공)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDv7K3WQjqGY1AWQfg5uTXWJKvLrBade2k",
            authDomain: "study-f3b4a.firebaseapp.com",
            projectId: "study-f3b4a",
            storageBucket: "study-f3b4a.firebasestorage.app",
            messagingSenderId: "452789603611",
            appId: "1:452789603611:web:6ee437e2195f05b6b457be",
            measurementId: "G-MLHV4LWBPQ"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase 서비스 초기화
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // DOM 요소 가져오기
        const authUi = document.getElementById('auth-ui');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const startButton = document.getElementById('start-btn');
        const mainSection = document.getElementById('main-section');
        const userDashboard = document.getElementById('user-dashboard');
        const welcomeMessage = document.getElementById('welcome-message');
        const userPhoto = document.getElementById('user-photo');
        const userIdDisplay = document.getElementById('user-id-display');
        
        // OCR 관련 DOM 요소들
        const ocrButton = document.getElementById('ocr-btn');
        const ocrSection = document.getElementById('ocr-section');
        const imageUpload = document.getElementById('image-upload');
        const imageContainer = document.getElementById('image-container');
        const processImageBtn = document.getElementById('process-image-btn');
        const statusArea = document.getElementById('status-area');
        const statusMessage = document.getElementById('status-message');
        const resultsArea = document.getElementById('results-area');
        const ocrTextDiv = document.getElementById('ocr-text');
        const solutionTextDiv = document.getElementById('solution-text');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');

        // 내 기록 관련 DOM 요소
        const myHistoryBtn = document.getElementById('my-history-btn');
        const historySection = document.getElementById('history-section');
        const historyList = document.getElementById('history-list');
        const backFromHistoryBtn = document.getElementById('back-from-history-btn');

        // 커뮤니티 관련 DOM 요소
        const communityBtn = document.getElementById('community-btn');
        const communitySection = document.getElementById('community-section');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const backFromCommunityBtn = document.getElementById('back-from-community-btn');

        let userFile = null;
        let currentUserId = null;

        // 대시보드 뉴스 업데이트 함수 (사용하지 않으므로 주석 처리)
        // function updateDashboardNews() {
        //     if (latestNewsFeedback) {
        //         latestNewsContent.textContent = latestNewsFeedback;
        //     } else {
        //         latestNewsContent.textContent = '놓치지 말아야 할 최신 업데이트와 공지사항을 확인하세요.';
        //     }
        // }

        // Firebase 인증 상태 변경 리스너
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                
                // UI 업데이트
                mainSection.classList.add('hidden');
                userDashboard.classList.remove('hidden');
                
                welcomeMessage.textContent = `안녕하세요, ${user.displayName || '손님'}님!`;
                userIdDisplay.textContent = `사용자 ID: ${currentUserId}`;
                if (user.photoURL) {
                    userPhoto.src = user.photoURL;
                }
                
                authUi.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600 hidden md:block">${user.displayName || '손님'}</span>
                        <button id="sign-out-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-red-600 transition-colors duration-300">
                            로그아웃
                        </button>
                    </div>
                `;
                document.getElementById('sign-out-btn').addEventListener('click', signOutUser);
                
                // 실시간 채팅 리스너 시작
                setupChatListener();
            } else {
                currentUserId = null;
                // UI 업데이트
                mainSection.classList.remove('hidden');
                userDashboard.classList.add('hidden');
                ocrSection.classList.add('hidden');
                historySection.classList.add('hidden');
                communitySection.classList.add('hidden');
                
                authUi.innerHTML = `
                    <button id="sign-in-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-purple-700 transition-colors duration-300">
                        Google로 로그인
                    </button>
                `;
                document.getElementById('sign-in-btn').addEventListener('click', signInWithGoogle);
            }
        });

        // 초기 인증 처리
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch(error => {
                console.error("Custom token login failed, signing in anonymously:", error);
                signInAnonymously(auth);
            });
        } else {
            signInAnonymously(auth);
        }

        // 구글 로그인
        async function signInWithGoogle() {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google 로그인 오류:", error);
            }
        }

        // 로그아웃
        async function signOutUser() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("로그아웃 오류:", error);
            }
        }

        // 이미지 미리보기
        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                userFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageContainer.innerHTML = `<img src="${e.target.result}" alt="Uploaded image" class="rounded-lg max-w-full h-auto">`;
                };
                reader.readAsDataURL(file);
                processImageBtn.disabled = false;
            } else {
                imageContainer.innerHTML = `<span class="text-gray-400">이미지 미리보기</span>`;
                userFile = null;
                processImageBtn.disabled = true;
            }
        });

        // OCR 처리 및 문제 풀이
        processImageBtn.addEventListener('click', async () => {
            if (!userFile) return;

            // 로딩 상태 표시
            statusArea.classList.remove('hidden');
            resultsArea.classList.add('hidden');
            solutionTextDiv.innerHTML = '';
            
            try {
                // OCR 시작
                statusMessage.textContent = "이미지에서 텍스트를 추출하는 중...";
                const result = await Tesseract.recognize(
                    userFile,
                    'kor+eng',
                    {
                        logger: m => console.log(m)
                    }
                );
                const extractedText = result.data.text;
                ocrTextDiv.textContent = extractedText;

                // AI에게 문제 풀이 요청
                statusMessage.textContent = "추출된 텍스트를 바탕으로 풀이를 생성하는 중...";
                const systemPrompt = "당신은 학생들의 문제 풀이를 도와주는 AI 튜터입니다. 제공된 텍스트에서 수학, 과학, 또는 기타 문제들을 찾아 자세한 풀이와 설명을 제공해주세요. 단순히 답만 제공하는 것이 아니라, 왜 그런 답이 나왔는지 단계별로 설명해주어야 합니다. 만약 텍스트에 문제가 없거나 관련이 없으면, '문제 해결에 도움을 드릴 수 없습니다.'라고 답변해주세요.";
                const userQuery = `다음 문제에 대한 풀이와 설명을 제공해 주세요. 문제: ${extractedText}`;
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };
                const apiKey = ""
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const apiResult = await response.json();
                const aiSolution = apiResult.candidates?.[0]?.content?.parts?.[0]?.text || "죄송합니다. 문제 풀이를 생성하는 데 실패했습니다.";
                
                solutionTextDiv.innerHTML = `<p class="whitespace-pre-wrap">${aiSolution}</p>`;

                // 문제 풀이 완료 후 Firestore에 기록 저장
                if (currentUserId) {
                    const historyCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/ocr_history`);
                    await addDoc(historyCollectionRef, {
                        extractedText: extractedText,
                        aiSolution: aiSolution,
                        timestamp: serverTimestamp()
                    });
                }

            } catch (error) {
                console.error("처리 오류:", error);
                solutionTextDiv.textContent = "오류가 발생했습니다. 다시 시도해 주세요.";
            } finally {
                statusArea.classList.add('hidden');
                resultsArea.classList.remove('hidden');
            }
        });

        // 내 기록 보기
        myHistoryBtn.addEventListener('click', async () => {
            userDashboard.classList.add('hidden');
            historySection.classList.remove('hidden');
            
            if (!currentUserId) {
                historyList.innerHTML = `<p class="text-gray-500">로그인 후 기록을 확인할 수 있습니다.</p>`;
                return;
            }

            try {
                historyList.innerHTML = `<div class="loading-spinner mx-auto"></div><p class="text-center text-gray-500 mt-2">기록을 불러오는 중...</p>`;
                const historyCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/ocr_history`);
                const q = query(historyCollectionRef, orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    historyList.innerHTML = `<p class="text-gray-500">아직 저장된 풀이 기록이 없습니다.</p>`;
                    return;
                }

                historyList.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : '날짜 없음';
                    const historyItem = document.createElement('div');
                    historyItem.className = 'bg-white p-6 rounded-lg shadow-md border-b border-gray-200';
                    historyItem.innerHTML = `
                        <p class="text-sm text-gray-400 mb-2">${date}</p>
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">문제:</h4>
                        <pre class="bg-gray-100 p-3 rounded-lg text-sm whitespace-pre-wrap">${data.extractedText}</pre>
                        <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">풀이:</h4>
                        <div class="bg-purple-50 p-3 rounded-lg text-sm whitespace-pre-wrap">${data.aiSolution}</div>
                    `;
                    historyList.appendChild(historyItem);
                });

            } catch (error) {
                console.error("내 기록 불러오기 오류:", error);
                historyList.innerHTML = `<p class="text-red-500">기록을 불러오는 중 오류가 발생했습니다. 다시 시도해 주세요.</p>`;
            }
        });

        // 커뮤니티 채팅 보기
        communityBtn.addEventListener('click', () => {
            userDashboard.classList.add('hidden');
            communitySection.classList.remove('hidden');
        });

        // 실시간 채팅 리스너
        function setupChatListener() {
            if (!currentUserId) return;
            const chatCollectionRef = collection(db, `artifacts/${appId}/public/data/community_chat`);
            const q = query(chatCollectionRef, orderBy('timestamp'));

            onSnapshot(q, (querySnapshot) => {
                chatMessages.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const messageElement = document.createElement('div');
                    messageElement.className = `p-3 rounded-lg shadow-sm ${data.userId === currentUserId ? 'bg-blue-100 ml-auto' : 'bg-gray-200 mr-auto'}`;
                    messageElement.style.maxWidth = '80%';
                    messageElement.innerHTML = `
                        <p class="text-xs font-bold text-gray-600 mb-1">${data.userName || data.userId.substring(0, 8)}</p>
                        <p class="text-sm text-gray-800 whitespace-pre-wrap">${data.message}</p>
                    `;
                    chatMessages.appendChild(messageElement);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, (error) => {
                console.error("채팅 리스너 오류:", error);
                chatMessages.innerHTML = `<p class="text-red-500 text-center">채팅을 불러오는 중 오류가 발생했습니다.</p>`;
            });
        }

        // 채팅 메시지 전송
        sendChatBtn.addEventListener('click', async () => {
            const message = chatInput.value.trim();
            if (message && currentUserId) {
                const chatCollectionRef = collection(db, `artifacts/${appId}/public/data/community_chat`);
                const user = auth.currentUser;
                await addDoc(chatCollectionRef, {
                    userId: currentUserId,
                    userName: user ? user.displayName : '손님',
                    message: message,
                    timestamp: serverTimestamp()
                });
                chatInput.value = '';
            }
        });

        // '시작하기' 버튼 클릭 이벤트 리스너
        startButton.addEventListener('click', () => {
            if (!auth.currentUser) {
                signInWithGoogle();
            }
        });
        
        // '문제 풀이 서포터' 버튼 클릭 시
        ocrButton.addEventListener('click', () => {
            userDashboard.classList.add('hidden');
            ocrSection.classList.remove('hidden');
        });

        // '대시보드로 돌아가기' 버튼 클릭 시 (OCR 섹션)
        backToDashboardBtn.addEventListener('click', () => {
            ocrSection.classList.add('hidden');
            userDashboard.classList.remove('hidden');
            // 상태 초기화
            imageUpload.value = '';
            imageContainer.innerHTML = `<span class="text-gray-400">이미지 미리보기</span>`;
            statusArea.classList.add('hidden');
            resultsArea.classList.add('hidden');
            ocrTextDiv.textContent = '';
            solutionTextDiv.textContent = '';
        });

        // '대시보드로 돌아가기' 버튼 클릭 시 (내 기록 섹션)
        backFromHistoryBtn.addEventListener('click', () => {
            historySection.classList.add('hidden');
            userDashboard.classList.remove('hidden');
        });

        // '대시보드로 돌아가기' 버튼 클릭 시 (커뮤니티 섹션)
        backFromCommunityBtn.addEventListener('click', () => {
            communitySection.classList.add('hidden');
            userDashboard.classList.remove('hidden');
        });

        // 모바일 메뉴 토글
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
    </script>
</body>
</html>
